<!DOCTYPE html>
<html lang="es">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente Solar Interactivo v2.1</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" integrity="sha512-gc3xjCmIy673V6MyOORYZXCHcwKAUhQsEhPrmUPbDdaDcEJYOwqjvyhQuNzRn8hZV+FKdWShTRdB+vVdJAbv/g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js" integrity="sha512-ozq8xQKq6urvuU6jNgkfqAmT7jKN2XumbrX1JiB+rvFRYLNbFiAUrGscLhBOZo7cDEzaxlLRNYIVgLoNQdTtrg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        html, body { height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; color: #333; overflow: hidden; }
        * { box-sizing: border-box; }
        .container { display: flex; flex-direction: column; height: 100vh; padding: 15px; }

        .progress-container { width: 100%; background-color: #e0e0e0; border-radius: 5px; margin-bottom: 15px; overflow: hidden; }
        .progress-bar { width: 0%; height: 15px; background-color: #ffc107; text-align: center; line-height: 15px; color: #333; font-size: 10px; font-weight: bold; border-radius: 5px 0 0 5px; transition: width 0.6s cubic-bezier(0.65, 0, 0.35, 1); }
        .progress-steps { display: flex; justify-content: space-between; font-size: 12px; padding: 5px 0; color: #555; }
        .progress-steps span { flex: 1; text-align: center; }

        .step { display: none; flex-grow: 1; overflow-y: auto; padding: 15px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .step.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .navigation-buttons { padding-top: 15px; display: flex; justify-content: space-between; }
        .nav-button { padding: 10px 25px; font-size: 16px; cursor: pointer; border: none; border-radius: 25px; transition: background-color 0.3s ease, transform 0.1s ease; }
        #prev-button { background-color: #ccc; color: #555; }
        #next-button { background-color: #ffc107; color: #333; font-weight: bold; }
        .nav-button:hover { filter: brightness(0.95); }
        .nav-button:active { transform: scale(0.98); }
        .nav-button:disabled { background-color: #e0e0e0; cursor: not-allowed; color: #999; }

        #map-container { position: relative; height: 400px; margin-bottom: 15px; }
        #map { height: 100%; width: 100%; z-index: 1; border-radius: 8px; }
        #search-container { position: absolute; top: 10px; left: 10px; z-index: 1050; width: 90%; max-width: 400px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); display: flex; align-items: center; padding: 5px; }
        #search-input { flex-grow: 1; height: 40px; padding: 0 15px; font-size: 16px; border: none; outline: none; border-radius: 4px; background: transparent; }
        #suggestions-container { position: absolute; top: calc(100% + 5px); left: 0; width: 100%; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); max-height: 200px; overflow-y: auto; display: none; z-index: 1049; }
        .suggestion-item { padding: 10px 15px; font-size: 14px; cursor: pointer; border-bottom: 1px solid #eee; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: #f5f5f5; }
        .suggestion-item small { display: block; color: #777; font-size: 11px; margin-top: 2px; }

        .interactive-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .interactive-section h3 { margin-top: 0; color: #0056b3; }
        .image-selector img { width: 100px; height: 100px; object-fit: cover; border: 3px solid #ddd; border-radius: 8px; margin: 5px; cursor: pointer; transition: all 0.25s ease; filter: grayscale(50%); }
        .image-selector img:hover { transform: scale(1.05); filter: grayscale(0%); }
        .image-selector img.selected { border-color: #ffc107; box-shadow: 0 0 15px rgba(255, 193, 7, 0.6); transform: scale(1.08); filter: grayscale(0%); }
        .slider-container { display: flex; align-items: center; margin-top: 10px; }
        .slider-container label { width: 100px; margin-right: 10px; font-size: 14px; }
        .slider-container input[type="range"] { flex-grow: 1; cursor: pointer; }
        .slider-container span { min-width: 40px; text-align: right; font-weight: bold; font-size: 14px; margin-left: 10px;}
        .icon-selector i { font-size: 24px; margin: 5px 10px; padding: 8px; border: 1px solid #ccc; border-radius: 50%; cursor: pointer; transition: background-color 0.3s, color 0.3s; }
        .icon-selector i:hover { background-color: #f0f0f0; }
        .icon-selector i.selected { background-color: #ffc107; color: #fff; border-color: #ffc107; }

        #results-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .result-card { background-color: #e9f5ff; padding: 15px; border-radius: 8px; text-align: center; }
        .result-card h4 { margin-top: 0; color: #0056b3; }
        .result-value { font-size: 24px; font-weight: bold; color: #003d7a; margin: 5px 0; min-height: 30px; }
        #chart-container { margin-top: 20px; background-color: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 1px 5px rgba(0,0,0,0.05);}
        #results-map-container { height: 250px; background-color: #eee; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-style: italic; color: #777; margin-top: 15px;}

    </style>
</head>
<body>
    <div class="container">

        <div class="progress-steps">
            <span>Ubicaci√≥n</span>
            <span>Tejado</span>
            <span>Consumo</span>
            <span>Resultados</span>
        </div>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>

        <div class="steps-container">
            <div id="step-1" class="step active">
                <h2>Paso 1: Dinos d√≥nde est√° tu tejado</h2>
                <p>Busca tu direcci√≥n o haz clic directamente en el mapa. Luego, dibuja el √°rea de tu tejado.</p>
                <div id="search-container">
                    <input type="text" id="search-input" placeholder="Buscar direcci√≥n en Espa√±a...">
                    <div id="suggestions-container"></div>
                </div>
                <div id="map-container">
                    <div id="map"></div>
                </div>
                <button id="draw-roof-button" class="nav-button" style="background-color: #007bff; color: white; margin-top: 10px;">‚úèÔ∏è Dibujar √Årea del Tejado</button>
                 <div id="area-info" style="margin-top: 10px; font-weight: bold;"></div>
            </div>

            <div id="step-2" class="step">
                <h2>Paso 2: Cu√©ntanos sobre tu tejado</h2>
                <div class="interactive-section">
                    <h3>Tipo de Tejado</h3>
                    <p>Selecciona la imagen que mejor represente tu tejado:</p>
                    <div class="image-selector" id="roof-type-selector">
                        <img src="https://via.placeholder.com/100/cccccc/ffffff?text=Plano" alt="Tejado Plano" data-value="plano">
                        <img src="https://via.placeholder.com/100/cccccc/ffffff?text=Inclinado" alt="Tejado Inclinado" data-value="inclinado">
                        <img src="https://via.placeholder.com/100/cccccc/ffffff?text=Dos+Aguas" alt="Tejado a Dos Aguas" data-value="dos_aguas">
                        <img src="https://via.placeholder.com/100/cccccc/ffffff?text=Complejo" alt="Tejado Complejo" data-value="complejo">
                    </div>
                </div>
                <div class="interactive-section">
                    <h3>Orientaci√≥n e Inclinaci√≥n</h3>
                    <div class="slider-container">
                        <label for="orientation-slider">Orientaci√≥n:</label>
                        <input type="range" id="orientation-slider" name="orientation" min="0" max="360" value="180">
                        <span id="orientation-value">Sur (180¬∞)</span>
                    </div>
                     <div class="slider-container">
                        <label for="tilt-slider">Inclinaci√≥n:</label>
                        <input type="range" id="tilt-slider" name="tilt" min="0" max="60" value="30">
                        <span id="tilt-value">30¬∞</span>
                    </div>
                </div>
                 <div class="interactive-section">
                    <h3>Obst√°culos y Sombras</h3>
                    <p>¬øHay alguno de estos elementos que proyecte sombra sobre el tejado?</p>
                    <div class="icon-selector" id="obstacle-selector">
                        <i class="fas fa-tree" data-value="arbol" title="√Årboles cercanos">üå≥</i>
                        <i class="fas fa-building" data-value="edificio" title="Edificios cercanos">üè¢</i>
                        <i class="fas fa-chimney" data-value="chimenea" title="Chimenea">üß±</i>
                         <i class="fas fa-satellite-dish" data-value="antena" title="Antena">üì°</i>
                    </div>
                </div>
            </div>

            <div id="step-3" class="step">
                <h2>Paso 3: ¬øCu√°nta energ√≠a consumes?</h2>
                <p>Indica tu gasto mensual aproximado en electricidad o tu consumo.</p>
                 <div class="interactive-section">
                     <h3>Gasto Mensual (‚Ç¨)</h3>
                     <div class="slider-container">
                         <label for="bill-slider">Gasto Aprox:</label>
                         <input type="range" id="bill-slider" name="bill" min="20" max="500" value="80" step="5">
                         <span id="bill-value">80 ‚Ç¨</span>
                     </div>
                     <p style="font-size: 12px; color: #555; text-align: center;">O introduce tu consumo medio mensual (kWh) si lo conoces:</p>
                     <input type="number" id="kwh-input" placeholder="Ej: 300 kWh" style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
                 </div>
            </div>

            <div id="step-4" class="step">
                <h2>Paso 4: ¬°Este es tu Potencial Solar!</h2>
                <p>Basado en la informaci√≥n proporcionada, esta es una estimaci√≥n:</p>
                <div id="results-container">
                    <div class="result-card">
                        <h4>Ahorro Anual Estimado</h4>
                        <div class="result-value" id="result-savings">0 ‚Ç¨</div>
                    </div>
                    <div class="result-card">
                        <h4>Instalaci√≥n Recomendada</h4>
                        <div class="result-value" id="result-kwp">--- kWp</div>
                    </div>
                     <div class="result-card">
                        <h4>Producci√≥n Anual</h4>
                        <div class="result-value" id="result-production">--- kWh</div>
                    </div>
                     <div class="result-card">
                        <h4>Impacto Ambiental (CO2 evitado/a√±o)</h4>
                        <div class="result-value" id="result-co2">--- kg</div>
                    </div>
                </div>
                <div id="chart-container">
                    <canvas id="resultsChart"></canvas>
                </div>
                <div id="results-map-container">
                     Visualizaci√≥n del tejado (pr√≥ximamente)
                 </div>
                <p style="margin-top: 20px; text-align: center; font-weight: bold;">¬øQuieres un estudio detallado y gratuito?</p>
                <button class="nav-button" style="width: 100%; background-color: #28a745; color: white; margin-top: 10px;">¬°S√≠, Solicitar Estudio Personalizado!</button>
            </div>
        </div>

        <div class="navigation-buttons">
            <button id="prev-button" class="nav-button" disabled>Anterior</button>
            <button id="next-button" class="nav-button">Siguiente</button>
        </div>

    </div>

    <script>
        let currentStep = 0;
        const steps = document.querySelectorAll('.step');
        const progressBar = document.getElementById('progress-bar');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const totalSteps = steps.length;
        let map;
        let drawnItems;
        let drawControl;
        let userPolygon = null;
        const markersData = {};
        const initialCoords = [40.103, -4.384];
        const initialZoom = 7;
        let resultsChartInstance = null;

        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();
            setupStepNavigation();
            updateProgressBar();
            setupSearch();
            setupInteractiveElements();
            console.log("Asistente Solar listo.");
        });

        function setupStepNavigation() {
            prevButton.addEventListener('click', () => changeStep(-1));
            nextButton.addEventListener('click', () => {
                 if (validateStep(currentStep)) {
                     if (currentStep === totalSteps - 1) {
                         nextButton.textContent = "Finalizado";
                         nextButton.disabled = true;
                     } else {
                         changeStep(1);
                     }
                 }
             });
            showStep(currentStep);
        }

        function changeStep(direction) {
            const newStep = currentStep + direction;
            if (newStep >= 0 && newStep < totalSteps) {
                currentStep = newStep;
                showStep(currentStep);
            }
        }

        function showStep(stepIndex) {
            steps.forEach((step, index) => {
                step.classList.toggle('active', index === stepIndex);
            });
            updateButtonStates();
            updateProgressBar();
             if (stepIndex === totalSteps - 1) {
                calculateAndShowResults();
                nextButton.textContent = "Finalizar";
             } else {
                 nextButton.textContent = "Siguiente";
             }
        }

        function updateButtonStates() {
            prevButton.disabled = currentStep === 0;
            nextButton.disabled = (currentStep === totalSteps - 1);
        }

        function updateProgressBar() {
            const progressPercentage = ((currentStep + 1) / totalSteps) * 100;
            progressBar.style.width = `${progressPercentage}%`;
            progressBar.textContent = `Paso ${currentStep + 1} de ${totalSteps}`;
        }

        function validateStep(stepIndex) {
             console.log(`Validando paso ${stepIndex + 1}`);
             if (stepIndex === 0) { if (!userPolygon) { alert("Por favor, dibuja el √°rea de tu tejado en el mapa."); return false; } }
             if (stepIndex === 1) { if (!document.querySelector('.image-selector img.selected')) { alert("Selecciona el tipo de tejado."); return false; } }
             if (stepIndex === 2) { const bill = document.getElementById('bill-slider').value; const kwh = document.getElementById('kwh-input').value; if (bill <= 20 && !kwh) { alert("Indica tu gasto o consumo energ√©tico."); return false; } }
            return true;
        }

        function initializeMap() {
            map = L.map('map', { zoomControl: false, attributionControl: true }).setView(initialCoords, initialZoom);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OSM</a> contributors' });
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Tiles &copy; Esri' });
            streetLayer.addTo(map);
            const baseMaps = { "Calles": streetLayer, "Sat√©lite": satelliteLayer };
            L.control.layers(baseMaps, null, { position: 'bottomleft' }).addTo(map);
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            document.getElementById('draw-roof-button').addEventListener('click', () => { startDrawing(); });
            map.on(L.Draw.Event.CREATED, handleDrawCreate);
            map.on(L.Draw.Event.EDITED, handleDrawEdit);
            map.on(L.Draw.Event.DELETED, handleDrawDelete);
        }

         function startDrawing() {
            if (drawControl) map.removeControl(drawControl);
            if (userPolygon) { drawnItems.removeLayer(userPolygon); userPolygon = null; document.getElementById('area-info').textContent = ''; }
            drawControl = new L.Control.Draw({ position: 'topright', draw: { polygon: { allowIntersection: false, shapeOptions: { color: '#ffc107', fillColor: '#ffc107', fillOpacity: 0.4 }, showArea: true, metric: true }, polyline: false, rectangle: false, circle: false, marker: false, circlemarker: false }, edit: { featureGroup: drawnItems, remove: true } });
            map.addControl(drawControl);
            alert("Herramienta de dibujo activada. Haz clic en el mapa para empezar a dibujar las esquinas de tu tejado. Doble clic para finalizar.");
        }

        function handleDrawCreate(event) {
            const layer = event.layer;
            if (userPolygon) drawnItems.removeLayer(userPolygon);
            userPolygon = layer;
            drawnItems.addLayer(layer);
            const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
            document.getElementById('area-info').textContent = `√Årea dibujada: ${area.toFixed(2)} m¬≤`;
        }

        function handleDrawEdit(event) { event.layers.eachLayer(layer => { if (layer instanceof L.Polygon) { userPolygon = layer; const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]); document.getElementById('area-info').textContent = `√Årea actualizada: ${area.toFixed(2)} m¬≤`; } }); }

        function handleDrawDelete(event) { event.layers.eachLayer(layer => { if (layer === userPolygon) { userPolygon = null; document.getElementById('area-info').textContent = ''; } }); }

        function setupSearch() {
            const searchInput = document.getElementById('search-input');
            const suggestionsContainer = document.getElementById('suggestions-container');
            const searchContainer = document.getElementById('search-container');
            let debounceTimer;
            function displaySuggestions(results) { suggestionsContainer.innerHTML = ''; if (results === null) { showSearchError("Error en el servidor."); return; } if (!results || results.length === 0) { suggestionsContainer.style.display = 'none'; return; } results.forEach(place => { const item = document.createElement('div'); item.classList.add('suggestion-item'); let displayName = place.display_name; let addressDetails = ''; if (place.address) { addressDetails = [ place.address.road || place.address.pedestrian, place.address.house_number, place.address.city || place.address.town || place.address.village, place.address.state ].filter(Boolean).join(', '); displayName = place.address.amenity || place.address.shop || place.address.tourism || place.name || displayName.split(',')[0]; } item.innerHTML = `${displayName} ${addressDetails ? `<small>${addressDetails}</small>` : ''}`; item.dataset.lat = place.lat; item.dataset.lon = place.lon; if (place.boundingbox && place.boundingbox.length === 4) { item.dataset.bbox = place.boundingbox.join(','); } else { item.dataset.bbox = ''; } item.addEventListener('click', () => { const lat = parseFloat(item.dataset.lat); const lon = parseFloat(item.dataset.lon); const bboxStr = item.dataset.bbox; let bbox = null; if (bboxStr) { bbox = bboxStr.split(',').map(Number); } if (bbox && bbox.length === 4) { map.fitBounds([[bbox[0], bbox[2]], [bbox[1], bbox[3]]]); } else if (!isNaN(lat) && !isNaN(lon)) { map.flyTo([lat, lon], 17); } searchInput.value = displayName; suggestionsContainer.innerHTML = ''; suggestionsContainer.style.display = 'none'; }); suggestionsContainer.appendChild(item); }); suggestionsContainer.style.display = 'block'; }
            function showSearchError(errorDetails) { console.error("Error b√∫squeda:", errorDetails); suggestionsContainer.innerHTML = '<div class="suggestion-item" style="color: red;">Error al buscar.</div>'; suggestionsContainer.style.display = 'block'; }
            function triggerSearch() { const query = searchInput.value; if (query.length < 3) { suggestionsContainer.innerHTML = ''; suggestionsContainer.style.display = 'none'; return; } suggestionsContainer.innerHTML = '<div class="suggestion-item" style="color: grey;">Buscando...</div>'; suggestionsContainer.style.display = 'block'; google.script.run .withSuccessHandler(displaySuggestions) .withFailureHandler(showSearchError) .searchNominatim(query); }
            searchInput.addEventListener('input', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(triggerSearch, 400); });
            document.addEventListener('click', (event) => { if (searchContainer && !searchContainer.contains(event.target)) { suggestionsContainer.style.display = 'none'; } });
        }

        function setupInteractiveElements() {
            const roofImages = document.querySelectorAll('#roof-type-selector img');
            roofImages.forEach(img => {
                img.addEventListener('click', () => {
                    roofImages.forEach(i => i.classList.remove('selected'));
                    img.classList.add('selected');
                    console.log("Tipo tejado:", img.dataset.value);
                });
            });
            const orientationSlider = document.getElementById('orientation-slider');
            const orientationValue = document.getElementById('orientation-value');
            orientationSlider.addEventListener('input', () => { const value = parseInt(orientationSlider.value); let direction = "Norte"; if (value > 337.5 || value <= 22.5) direction = "Norte"; else if (value <= 67.5) direction = "Noreste"; else if (value <= 112.5) direction = "Este"; else if (value <= 157.5) direction = "Sureste"; else if (value <= 202.5) direction = "Sur"; else if (value <= 247.5) direction = "Suroeste"; else if (value <= 292.5) direction = "Oeste"; else if (value <= 337.5) direction = "Noroeste"; orientationValue.textContent = `${direction} (${value}¬∞)`; });
            orientationSlider.dispatchEvent(new Event('input'));
            const tiltSlider = document.getElementById('tilt-slider');
            const tiltValue = document.getElementById('tilt-value');
            tiltSlider.addEventListener('input', () => { tiltValue.textContent = `${tiltSlider.value}¬∞`; });
            tiltSlider.dispatchEvent(new Event('input'));
            const obstacleIcons = document.querySelectorAll('#obstacle-selector i');
             obstacleIcons.forEach(icon => { icon.addEventListener('click', () => { icon.classList.toggle('selected'); console.log("Obst√°culos:", Array.from(document.querySelectorAll('#obstacle-selector i.selected')).map(i => i.dataset.value)); }); });
             const billSlider = document.getElementById('bill-slider');
             const billValue = document.getElementById('bill-value');
             const kwhInput = document.getElementById('kwh-input');
             billSlider.addEventListener('input', () => { billValue.textContent = `${billSlider.value} ‚Ç¨`; kwhInput.value = ''; });
             kwhInput.addEventListener('input', () => { billSlider.value = 20; billValue.textContent = `20 ‚Ç¨`; });
            billSlider.dispatchEvent(new Event('input'));
        }

        function animateCounter(elementId, targetValue, duration = 1500, suffix = ' ‚Ç¨') {
            const element = document.getElementById(elementId);
            if (!element) return;
            const startValue = 0;
            const range = targetValue - startValue;
            let startTime = null;
            function step(timestamp) {
                if (!startTime) startTime = timestamp;
                const progress = timestamp - startTime;
                const increment = Math.min(progress / duration, 1);
                const currentValue = Math.floor(startValue + range * increment);
                element.textContent = currentValue + suffix;
                if (increment < 1) {
                    requestAnimationFrame(step);
                } else {
                     element.textContent = targetValue + suffix;
                }
            }
            requestAnimationFrame(step);
        }

        function calculateAndShowResults() {
            console.log("Calculando resultados...");
            const locationData = userPolygon ? userPolygon.toGeoJSON() : null;
            const area = userPolygon ? L.GeometryUtil.geodesicArea(userPolygon.getLatLngs()[0]) : 0;
            const roofType = document.querySelector('.image-selector img.selected')?.dataset.value;
            const orientation = document.getElementById('orientation-slider').value;
            const tilt = document.getElementById('tilt-slider').value;
             const obstacles = Array.from(document.querySelectorAll('#obstacle-selector i.selected')).map(i => i.dataset.value);
            const bill = document.getElementById('bill-slider').value;
            const kwh = document.getElementById('kwh-input').value;

            const estimatedKwp = Math.max(0, (area / 8 - obstacles.length * 0.5)).toFixed(1);
            const estimatedProduction = (estimatedKwp * 1500).toFixed(0);
            const estimatedSavingsRaw = Math.max(0, (bill * 12 * 0.6));
            const co2Avoided = (estimatedProduction * 0.3).toFixed(0);

             animateCounter('result-savings', Math.floor(estimatedSavingsRaw), 1500, ' ‚Ç¨');
            document.getElementById('result-kwp').textContent = `${estimatedKwp} kWp`;
            document.getElementById('result-production').textContent = `${estimatedProduction} kWh`;
            document.getElementById('result-co2').textContent = `${co2Avoided} kg`;

             const ctx = document.getElementById('resultsChart').getContext('2d');
             const monthlyProductionFactors = [0.4, 0.5, 0.8, 1.0, 1.2, 1.3, 1.35, 1.25, 1.0, 0.7, 0.5, 0.35];
             const estimatedMonthlyProduction = monthlyProductionFactors.map(factor =>
                 Math.floor(factor * (estimatedProduction / 12))
             );
             const chartData = {
                labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                datasets: [{
                    label: 'Producci√≥n Solar Estimada (kWh/mes)',
                    data: estimatedMonthlyProduction,
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.3)',
                    fill: true,
                    tension: 0.3,
                    pointBackgroundColor: '#ffc107',
                    pointRadius: 4
                }]
            };

             if (resultsChartInstance) {
                 resultsChartInstance.destroy();
             }

            resultsChartInstance = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Estimaci√≥n de Producci√≥n vs Consumo Mensual',
                            font: { size: 16 }
                        },
                        legend: { position: 'top' },
                         tooltip: { enabled: true, mode: 'index', intersect: false }
                    },
                     scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Energ√≠a (kWh)' } },
                        x: { title: { display: true, text: 'Mes' } }
                    },
                    animation: { duration: 800, easing: 'easeInOutQuart' }
                }
            });

             const resultsMapContainer = document.getElementById('results-map-container');
             resultsMapContainer.innerHTML = `Visualizaci√≥n Tejado (${area.toFixed(1)}m¬≤) - Pendiente`;
        }

    </script>
</body>
</html>
