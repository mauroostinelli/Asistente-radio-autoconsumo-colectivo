<!DOCTYPE html>
<html lang="es">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>☀️ Asistente radio autoconsumo colectivo</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* --- Variables CSS --- */
        :root {
            --primary-color: #3388FF; /* Azul Leaflet */
            --secondary-color: #FF5733; /* Naranja Energía */
            --text-color: #333;
            --bg-color: #f8f9fa;
            --white: #ffffff;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --shadow-medium: rgba(0, 0, 0, 0.2);
            --blue-light: #3388FF;
            --orange-energy: #FF5733;
        }

        /* Estilos Globales, Mapa, Indicador Carga (sin cambios) ... */
        html, body { height: 100%; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; background-color: var(--bg-color); overflow: hidden; }
        * { box-sizing: border-box; }
        #map { height: 100vh; width: 100%; position: relative; z-index: 1; filter: brightness(1); transition: filter 0.5s ease; }
        #map.loading { filter: brightness(0.9) blur(1px); }
        #loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 2000; flex-direction: column; transition: opacity 0.5s ease-out; }
        #loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .spinner { border: 5px solid var(--shadow-light); border-top: 5px solid var(--blue-light); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        #loading-overlay p { font-weight: 600; color: var(--text-color); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Estilos Barra Búsqueda, Sugerencias (sin cambios funcionales) ... */
        #search-container { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1050; width: 90%; max-width: 450px; background-color: var(--white); border-radius: 30px; box-shadow: 0 4px 12px var(--shadow-medium); display: flex; align-items: center; padding: 8px 15px; transition: all 0.3s ease; }
        #search-container:focus-within { box-shadow: 0 6px 16px rgba(51, 136, 255, 0.5); }
        #search-input { flex-grow: 1; height: 40px; padding: 0 10px 0 35px; font-size: 16px; border: none; outline: none; border-radius: 30px; background: transparent; color: var(--text-color); position: relative; }
        #search-input::placeholder { color: #999; font-weight: 300; }
        #search-container::before { font-family: "Font Awesome 6 Free"; content: "\f002"; font-weight: 900; position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: #aaa; font-size: 16px; z-index: 1; }
        #suggestions-container { position: absolute; top: calc(100% + 8px); left: 0; width: 100%; background-color: var(--white); border-radius: 15px; box-shadow: 0 4px 12px var(--shadow-light); max-height: 350px; overflow-y: auto; display: none; z-index: 1049; border: 1px solid #eee; }
        .suggestion-item { padding: 12px 20px; font-size: 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; white-space: normal; line-height: 1.4; transition: background-color 0.2s ease; color: var(--text-color); }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: #f5f5f5; }
        .suggestion-item strong { font-weight: 600; color: var(--blue-light); display: block; margin-bottom: 3px; }
        .suggestion-item small { display: block; color: #666; font-size: 13px; font-weight: 300; }
        .suggestion-message { padding: 15px 20px; color: #888; font-style: italic; display: flex; align-items: center; justify-content: center; }
        .suggestion-message .spinner-small { width: 18px; height: 18px; border-width: 2px; border: 2px solid var(--shadow-light); border-top-color: var(--secondary-color); border-radius: 50%; margin-right: 8px; animation: spin 0.8s linear infinite; }

        /* Controles Leaflet (Zoom) (sin cambios) */
         .leaflet-control-zoom { border: none !important; border-radius: 8px !important; box-shadow: 0 2px 8px var(--shadow-medium) !important; }
         .leaflet-control-zoom a { color: var(--blue-light) !important; font-weight: bold !important; }

        /* Estilos Control de Capas con Miniaturas (sin cambios) */
        .leaflet-control-layers { border: none !important; border-radius: 8px !important; box-shadow: 0 2px 8px var(--shadow-medium) !important; padding: 6px; }
        .leaflet-control-layers-base label { display: flex; align-items: center; margin-bottom: 6px; cursor: pointer; }
        .leaflet-control-layers-base label span { display: flex; align-items: center; margin-left: 5px; }
        img.layer-thumbnail { width: 45px; height: 45px; border: 2px solid #ddd; border-radius: 4px; object-fit: cover; transition: border-color 0.2s ease, transform 0.1s ease; }
        .leaflet-control-layers-selector:checked + span img.layer-thumbnail { border-color: var(--blue-light); }
        label:hover img.layer-thumbnail { transform: scale(1.03); border-color: #aaa; }
        .leaflet-control-layers-selector:checked + span img.layer-thumbnail { transform: scale(1); }
        .layer-label-text { font-size: 13px; margin-left: 8px; color: var(--text-color); }

        /* Estilos Popups (sin cambios) ... */
         .leaflet-popup-content-wrapper { background-color: var(--white); border-radius: 12px; box-shadow: 0 3px 15px var(--shadow-medium); }
         .leaflet-popup-content { margin: 15px 20px !important; font-size: 14px; line-height: 1.6; text-align: center; color: var(--text-color); }
         .popup-title { font-weight: 600; font-size: 16px; color: var(--secondary-color); margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
         .popup-coords { font-size: 13px; color: #555; margin-bottom: 15px; }
         .popup-coords span { font-weight: 600; color: var(--blue-light); }
         .popup-delete-button { margin-top: 10px; padding: 8px 18px; cursor: pointer; background: linear-gradient(45deg, #ff6b6b, #ee5253); color: white; border: none; border-radius: 20px; font-weight: 600; font-size: 13px; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(255, 107, 107, 0.4); }
         .popup-delete-button:hover { background: linear-gradient(45deg, #ee5253, #ff6b6b); box-shadow: 0 4px 8px rgba(255, 107, 107, 0.6); transform: translateY(-1px); }
         .popup-delete-button i { margin-right: 5px; }

        /* Círculos de Radio (sin cambios) */
        .autoconsumo-circle {}

        /* --- Etiquetas de Radio (Posición Ajustada v4 - Hacia el Interior) --- */
        .radius-label {
            background: rgba(255, 255, 255, 0.85); /* Un poco más opaco */
            border: none;
            color: var(--secondary-color);
            font-weight: 600;
            font-size: 11px;
            padding: 3px 6px;
            border-radius: 4px;
            box-shadow: 0 1px 3px var(--shadow-light);
            white-space: nowrap;
            text-align: center;
            pointer-events: none;
            z-index: 650; /* Asegurar que esté sobre los círculos */
        }
        /* Ajuste Posiciones: Mover ligeramente hacia el interior desde el borde */
        /* El punto (0,0) del translate está en la esquina superior izquierda de la etiqueta,
           que a su vez está en el punto calculado sobre la circunferencia. */
        .label-north { /* El punto está en el borde N. Mover etiqueta abajo y centrar H. */
            transform: translate(-50%, 5px); /* Mitad ancho a la izq, 5px hacia abajo */
        }
        .label-south { /* El punto está en el borde S. Mover etiqueta arriba y centrar H. */
            transform: translate(-50%, calc(-100% - 5px)); /* Mitad ancho a la izq, altura completa + 5px hacia arriba */
        }
        .label-east {  /* El punto está en el borde E. Mover etiqueta a la izquierda y centrar V. */
            transform: translate(calc(-100% - 5px), -50%); /* Ancho completo + 5px a la izq, mitad altura hacia arriba */
        }
        .label-west {  /* El punto está en el borde W. Mover etiqueta a la derecha y centrar V. */
            transform: translate(5px, -50%); /* 5px a la derecha, mitad altura hacia arriba */
        }
        /* --- Fin Ajuste Posición Etiquetas --- */


        /* Icono marcador (sin cambios) */
        .solar-marker-icon { text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }

    </style>
</head>
<body>

    <div id="loading-overlay"> <div class="spinner"></div> <p>Cargando Explorador Solar...</p> </div>
    <div id="map"></div>
    <div id="search-container"> <input type="text" id="search-input" placeholder="Busca tu dirección o localidad..."> <div id="suggestions-container"></div> </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // Configuración Inicial Mapa (sin cambios) ...
        const initialCoords = [40.103, -4.384]; const initialZoom = 7; const loadingOverlay = document.getElementById('loading-overlay'); const mapElement = document.getElementById('map');
        mapElement.classList.add('loading');
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView(initialCoords, initialZoom);
        L.control.attribution({ position: 'bottomright', prefix: '<a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a>' }).addTo(map);

        // --- Definir Capas y Controles (Miniaturas Mejoradas v2) ---
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // Capas Base
        const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OSM</a>' });
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Tiles &copy; Esri' });
        const topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { maxZoom: 17, attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)' });

        // Listeners de error
        streetLayer.on('tileerror', function(error, tile) { console.warn('Error tesela Calles:', error.error); });
        satelliteLayer.on('tileerror', function(error, tile) { console.warn('Error tesela Satélite:', error.error); });
        topoLayer.on('tileerror', function(error, tile) { console.warn('Error tesela Topo:', error.error); });

        streetLayer.addTo(map); // Capa inicial

        // --- Miniaturas Base64 (Más Representativas v2 - Aprox 50x50) ---
        // **NOTA:** Si el problema de las miniaturas grises persiste, realiza las pruebas de diagnóstico mencionadas (verificar copia/pega, probar URL externa).
        const thumbOsm = 'data:image/png;base64,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';
        const thumbSatellite = 'data:image/png;base64,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';
        const thumbTopo = 'data:image/png;base64,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';
        // --- Fin Miniaturas ---

        // Definir mapas base usando las miniaturas mejoradas
        const baseMaps = {
            [`<span><img src="${thumbOsm}" class="layer-thumbnail" alt="Calles"> <span class="layer-label-text">Calles</span></span>`]: streetLayer,
            [`<span><img src="${thumbSatellite}" class="layer-thumbnail" alt="Satélite"> <span class="layer-label-text">Satélite</span></span>`]: satelliteLayer,
            [`<span><img src="${thumbTopo}" class="layer-thumbnail" alt="Topográfico"> <span class="layer-label-text">Topo</span></span>`]: topoLayer
        };

        L.control.layers(baseMaps, null, { position: 'bottomleft', collapsed: false }).addTo(map);

        // --- Indicador de Carga (sin cambios) ---
        map.whenReady(() => { console.log("Mapa listo (whenReady)."); streetLayer.once('load', () => { console.log("Capa base cargada (load). Ocultando overlay."); loadingOverlay.classList.add('hidden'); mapElement.classList.remove('loading'); }); setTimeout(() => { if (!loadingOverlay.classList.contains('hidden')) { console.warn("Fallback timeout: Ocultando overlay después de 3.5 segundos."); loadingOverlay.classList.add('hidden'); mapElement.classList.remove('loading'); } }, 3500); });

        // --- Lógica Barra de Búsqueda (fetch) (sin cambios) ---
        /* ... El código de búsqueda con fetch se mantiene igual ... */
        const searchInput = document.getElementById('search-input'); const suggestionsContainer = document.getElementById('suggestions-container'); const searchContainer = document.getElementById('search-container'); let debounceTimer;
        function displaySuggestions(results) { console.log(">>> displaySuggestions EJECUTADA. Resultados recibidos:", results); suggestionsContainer.innerHTML = ''; if (results === null || results === undefined) { console.log("   Resultados son null/undefined, mostrando error."); suggestionsContainer.innerHTML = '<div class="suggestion-message">😕 Error al buscar. Intenta de nuevo.</div>'; suggestionsContainer.style.display = 'block'; return; } if (typeof results.error === 'string') { console.log("   La API devolvió un error:", results.error); showSearchError({ message: results.error }); return; } if (!Array.isArray(results) || results.length === 0) { console.log("   Resultados vacíos, no es array o no válidos."); suggestionsContainer.style.display = 'none'; return; } console.log(`   Procesando ${results.length} resultados.`); results.forEach(place => { const item = document.createElement('div'); item.classList.add('suggestion-item'); let mainName = place.address?.amenity || place.address?.shop || place.address?.tourism || place.address?.building || place.name || place.display_name.split(',')[0]; let details = [ place.address?.road || place.address?.pedestrian, place.address?.house_number, place.address?.suburb, place.address?.city || place.address?.town || place.address?.village, place.address?.state, place.address?.country ].filter(Boolean).join(', '); if (details.toLowerCase().includes(mainName.toLowerCase()) && details.length > mainName.length + 5) { mainName = place.display_name.split(',')[0]; } item.innerHTML = `<strong>${mainName}</strong><small>${details || place.display_name}</small>`; item.dataset.lat = place.lat; item.dataset.lon = place.lon; item.dataset.displayName = mainName; if (place.boundingbox && place.boundingbox.length === 4) { item.dataset.bbox = place.boundingbox.join(','); } else { item.dataset.bbox = ''; } item.addEventListener('click', () => { const lat = parseFloat(item.dataset.lat); const lon = parseFloat(item.dataset.lon); const bboxStr = item.dataset.bbox; let bbox = null; if (bboxStr) { bbox = bboxStr.split(',').map(Number); } if (bbox && bbox.length === 4 && (bbox[1] - bbox[0]) > 0.0001 && (bbox[3] - bbox[2]) > 0.0001) { map.flyToBounds([[bbox[0], bbox[2]], [bbox[1], bbox[3]]], { padding: [50, 50], maxZoom: 17, duration: 1 }); } else if (!isNaN(lat) && !isNaN(lon)) { map.flyTo([lat, lon], 16, { duration: 1 }); } searchInput.value = item.dataset.displayName; suggestionsContainer.innerHTML = ''; suggestionsContainer.style.display = 'none'; }); suggestionsContainer.appendChild(item); }); suggestionsContainer.style.display = 'block'; }
        function showSearchError(errorDetails) { const message = errorDetails?.message || "Error desconocido."; console.error(">>> showSearchError EJECUTADA. Detalles:", errorDetails); suggestionsContainer.innerHTML = `<div class="suggestion-message">❌ Error al buscar: ${message}</div>`; suggestionsContainer.style.display = 'block'; }
        function triggerSearch() { const query = searchInput.value.trim(); if (query.length < 3) { suggestionsContainer.innerHTML = ''; suggestionsContainer.style.display = 'none'; return; } suggestionsContainer.innerHTML = `<div class="suggestion-message"><div class="spinner spinner-small"></div>Buscando '${query}'...</div>`; suggestionsContainer.style.display = 'block'; const apiUrl = `/api/search?query=${encodeURIComponent(query)}`; fetch(apiUrl) .then(response => { if (!response.ok) { return response.json().then(errorData => { throw new Error(errorData.error || `Error ${response.status}: ${response.statusText}`); }).catch(() => { throw new Error(`Error ${response.status}: ${response.statusText}`); }); } return response.json(); }) .then(results => { displaySuggestions(results); }) .catch(error => { console.error("Error en fetch o procesamiento:", error); showSearchError(error); }); }
        searchInput.addEventListener('input', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(triggerSearch, 450); });
        document.addEventListener('click', (event) => { if (searchContainer && !searchContainer.contains(event.target)) { suggestionsContainer.style.display = 'none'; } });

        // --- Lógica Marcadores/Círculos (Etiquetas ajustadas por CSS v4) ---
        /* ... Las funciones calculateDestinationPoint, createLabel, addMarkerWithCirclesAndLabels, removeMarkerAndElements, map.on('click') se mantienen igual que en la versión anterior ... */
        const markersData = {};
        function calculateDestinationPoint(lat, lon, distance, bearing) { const R = 6371e3; const lat1Rad = lat * Math.PI / 180; const lon1Rad = lon * Math.PI / 180; const bearingRad = bearing * Math.PI / 180; const dRad = distance / R; const lat2Rad = Math.asin(Math.sin(lat1Rad) * Math.cos(dRad) + Math.cos(lat1Rad) * Math.sin(dRad) * Math.cos(bearingRad)); const lon2Rad = lon1Rad + Math.atan2(Math.sin(bearingRad) * Math.sin(dRad) * Math.cos(lat1Rad), Math.cos(dRad) - Math.sin(lat1Rad) * Math.sin(lat2Rad)); return L.latLng(lat2Rad * 180 / Math.PI, lon2Rad * 180 / Math.PI); }
        function createLabel(latlng, text, positionClass) {
            const labelIcon = L.divIcon({
                className: `radius-label ${positionClass}`, // Se aplican las clases CSS aquí
                html: text,
                iconSize: null, // Deja que CSS controle el tamaño con padding
                // No establezcas iconAnchor aquí, confía en el default [0,0] y CSS transform
            });
            return L.marker(latlng, {
                 icon: labelIcon,
                 interactive: false, // Las etiquetas no deben ser clickables
                 pane: 'markerPane', // Intenta usar markerPane o tooltipPane si shadowPane da problemas
                 // zIndexOffset: 10 // Opcional si necesitas ajustar el apilamiento
            }).addTo(map);
        }
        function addMarkerWithCirclesAndLabels(latlng) { const solarIcon = L.divIcon({ html: '<i class="fas fa-solar-panel fa-2x" style="color: var(--blue-light);"></i>', className: 'solar-marker-icon', iconSize: [30, 30], iconAnchor: [15, 30] }); const marker = L.marker(latlng, { icon: solarIcon, draggable: false }).addTo(map); const markerId = L.Util.stamp(marker); const radii = [ { radius: 500, label: "500m", color: '#3388FF', opacity: 0.60 }, { radius: 2000, label: "2km", color: '#FF5733', opacity: 0.40 } ]; const bearings = [ { bearing: 0, posClass: 'label-north' }, { bearing: 180, posClass: 'label-south' }, { bearing: 90, posClass: 'label-east' }, { bearing: 270, posClass: 'label-west' } ]; const createdCircles = [], createdLabels = []; try { radii.forEach(rInfo => { const circle = L.circle(latlng, { radius: rInfo.radius, color: rInfo.color, fillColor: rInfo.color, fillOpacity: rInfo.opacity, weight: 1.5, className: 'autoconsumo-circle' }).addTo(map); createdCircles.push(circle); bearings.forEach(bInfo => { const labelLatLng = calculateDestinationPoint(latlng.lat, latlng.lng, rInfo.radius, bInfo.bearing); createdLabels.push(createLabel(labelLatLng, rInfo.label, bInfo.posClass)); }); }); markersData[markerId] = { marker: marker, circles: createdCircles, labels: createdLabels }; const popupContent = ` <div class="popup-title">📍 Punto Seleccionado</div> <div class="popup-coords"> <span>Lat:</span> ${latlng.lat.toFixed(5)}<br> <span>Lng:</span> ${latlng.lng.toFixed(5)} </div> <div style="font-size: 12px; color: #777; margin-bottom: 15px;">Radios de autoconsumo: 500m y 2km</div> <button class="popup-delete-button" onclick="removeMarkerAndElements(${markerId})"> <i class="fas fa-trash-alt"></i> Eliminar Punto </button> `; marker.bindPopup(popupContent).openPopup(); marker.on('click', () => marker.openPopup()); } catch (e) { console.error("Error al crear círculos/etiquetas:", e); if (marker) map.removeLayer(marker); createdCircles.forEach(c => map.removeLayer(c)); createdLabels.forEach(l => map.removeLayer(l)); delete markersData[markerId]; alert("Hubo un problema al añadir el punto."); } }
        window.removeMarkerAndElements = function(markerId) { const data = markersData[markerId]; if (data) { data.labels.forEach(label => map.removeLayer(label)); data.circles.forEach(circle => map.removeLayer(circle)); map.removeLayer(data.marker); delete markersData[markerId]; } else { console.warn("Intento de eliminar marcador no encontrado con ID:", markerId); } }
        map.on('click', function(e) { let target = e.originalEvent.target; let clickedOnInteractiveElement = false; while (target && target !== map._container) { if (target.classList.contains('leaflet-marker-icon') || target.classList.contains('leaflet-control') || target.closest('.leaflet-popup-content-wrapper')) { clickedOnInteractiveElement = true; break; } target = target.parentNode; } if (!clickedOnInteractiveElement) { addMarkerWithCirclesAndLabels(e.latlng); } });

    </script>
</body>
</html>
